<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İşletme Yönetimi - İletişim Bilgileri</title>
    <link rel="stylesheet" href="styles11.css">
    <script src="/frontend/src/js/businessInfo.js"></script>
</head>
<body>
    <div class="container">
        <!-- Tab-bar -->
        <div class="tab-bar">
            <a href="/frontend/public/pages/isletme_panel/ayarlar/genel_ayarlar/index17.html">Genel Ayarlar</a>
            <a href="/frontend/public/pages/isletme_panel/ayarlar/randevu_ayarlari/index9.html">Randevu Ayarları</a>
            <a href="/frontend/public/pages/isletme_panel/ayarlar/galeri_ayarlari/index7.html">Galeri Ayarları</a>
            <a href="/frontend/public/pages/isletme_panel/ayarlar/iletisim_ayarlari/index11.html">İletişim Ayarları</a>
            <a href="/frontend/public/pages/isletme_panel/ayarlar/sss_ayarlari/index12.html">SSS Ayarları</a>
        </div>

        <aside class="sidebar">
            <img id="business-image" src="/frontend/src/assets/images/default-image.png" alt="İşletme Fotoğrafı">
            <h1 id="sidebar-h1">Varsayılan İşletme</h1>
            <h2 id="sidebar-h2">Panel</h2>
            <nav>
                <ul>
                    <li><a href="/frontend/public/pages/isletme_panel/anasayfa/index6.html">Randevu Yönetimi</a></li>
                    <li><a href="/frontend/public/pages/isletme_panel/personel/index27.html">Personel Yönetimi</a></li>
                    <li><a href="/frontend/public/pages/isletme_panel/performans/index30.html" class="active">İşletme Performansı</a></li>
                    <li><a href="/frontend/public/pages/isletme_panel/ayarlar/genel_ayarlar/index17.html">Ayarlar</a></li>
                </ul>
            </nav>
        </aside>

        <button class="mobile-menu-toggle" id="menu-toggle">&#9776;</button>
            
            <header class="mobile-header" id="mobile-header">
                <img id="mobile-business-image" src="/frontend/src/assets/images/default-image.png" alt="İşletme Fotoğrafı" />
                <h1 id="mobile-business-name">İşletme Adı</h1>
            </header>

            <div class="mobile-menu" id="mobile-menu">
                <ul>
                    <li><a href="/frontend/public/pages/isletme_panel/anasayfa/index6.html">Randevu Yönetimi</a></li>
                    <li><a href="/frontend/public/pages/isletme_panel/personel/index27.html">Personel Yönetimi</a></li>
                    <li><a href="/frontend/public/pages/isletme_panel/performans/index30.html">İşletme Performansı</a></li>
                    <li class="has-submenu">
                        <a href="#">Ayarlar</a>
                        <ul class="submenu">
                            <li><a href="/frontend/public/pages/isletme_panel/ayarlar/genel_ayarlar/index17.html">Genel Ayarlar</a></li>
                            <li><a href="/frontend/public/pages/isletme_panel/ayarlar/randevu_ayarlari/index9.html">Randevu Ayarları</a></li>
                            <li><a href="/frontend/public/pages/isletme_panel/ayarlar/galeri_ayarlari/index7.html">Galeri Ayarları</a></li>
                            <li><a href="/frontend/public/pages/isletme_panel/ayarlar/iletisim_ayarlari/index11.html">İletişim Ayarları</a></li>
                            <li><a href="/frontend/public/pages/isletme_panel/ayarlar/sss_ayarlari/index12.html">SSS Ayarları</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

        <main class="main-content">
            <section class="settings">
                <h2>İletişim Ayarları</h2>
                <form id="contactForm">
                    <div class="form-group">
                        <label for="phone">Telefon Numaranız</label>
                        <input type="text" id="phone" placeholder="+90 (XXX) XXX XXXX" required>
                    </div>

                    <div class="form-group">
                        <label for="province">İl</label>
                        <input type="text" id="province" placeholder="İl" required>
                    </div>

                    <div class="form-group">
                        <label for="district">İlçe</label>
                        <input type="text" id="district" placeholder="İlçe" required>
                    </div>

                    <div class="form-group">
                        <label for="neighborhood">Mahalle</label>
                        <input type="text" id="neighborhood" placeholder="Mahalle" required>
                    </div>

                    <div class="form-group">
                        <label for="addressNo">No</label>
                        <input type="text" id="addressNo" placeholder="No" required>
                    </div>

                    <button type="submit" class="btn">Güncelle</button>
                    <p id="successMessage" class="success-message">Başarıyla güncellendi!</p>
                </form>
            </section>
            
            <section class="set">
                <h2>Ön İzleme</h2>
                <form>
                    <!-- Buraya düzenleme bloğu eklendi -->
                    <div class="contact-details" style="margin-top: 20px;">
                        <div id="contactPreview"></div>
                        <button id="editBtn" type="button" class="btn">Düzenle</button>
                    </div>
                </form>
            </section>

        </main>
    </div>

    <script>
    const contactDetailsDiv = document.querySelector('#contactPreview');
    const editBtn = document.getElementById('editBtn');

    let currentContactData = {}; // global veri saklayıcı

    document.addEventListener('DOMContentLoaded', async function () {
        await loadBusinessInfo();
        await loadContactData();
    });

    async function loadContactData() {
        try {
            const response = await fetch("http://127.0.0.1:8000/api/iletisim");
            const data = await response.json();

            if (response.ok) {
                currentContactData = data; // verileri sakla

                contactDetailsDiv.innerHTML = `
                    <p><strong>Telefon:</strong> ${data.telefon}</p>
                    <p><strong>İl:</strong> ${data.il}</p>
                    <p><strong>İlçe:</strong> ${data.ilce}</p>
                    <p><strong>Mahalle:</strong> ${data.mahalle}</p>
                    <p><strong>No:</strong> ${data.no}</p>
                `;

                loadMapWithAddress(`${data.mahalle}, ${data.ilce}, ${data.il}`);
            } else {
                contactDetailsDiv.innerHTML = `<p></p>`;
            }
        } catch (err) {
            console.error("İletişim verileri alınamadı:", err);
        }
    }

        window.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch("http://localhost:8000/api/genel-ayarlar/liste");
                const ayarlar = await response.json();
                const ayar = ayarlar[0];

                if (ayar) {
                    // Ana başlık ve alt başlığı tüm sayfalarda güncelle
                    if (ayar.logo) {
                        document.getElementById("business-image").src = ayar.logo;
                        const mobileImage = document.getElementById("mobile-business-image");
                        if (mobileImage) mobileImage.src = ayar.logo;
                    }

                    if (ayar.isletme_adi) {
                        document.getElementById("sidebar-h1").textContent = ayar.isletme_adi;
                        const mobileName = document.getElementById("mobile-business-name");
                        if (mobileName) mobileName.textContent = ayar.isletme_adi;
                    }

                    if (ayar.aciklama) {
                        const subtitle = document.getElementById("sidebar-h2");
                        if (subtitle) subtitle.textContent = ayar.aciklama;
                    }
                }
            } catch (error) {
                console.error("Genel ayarlar alınamadı:", error);
            }
        });


    editBtn.addEventListener("click", function () {
        // inputları doldur
        document.getElementById('phone').value = currentContactData.telefon || '';
        document.getElementById('province').value = currentContactData.il || '';
        document.getElementById('district').value = currentContactData.ilce || '';
        document.getElementById('neighborhood').value = currentContactData.mahalle || '';
        document.getElementById('addressNo').value = currentContactData.no || '';

        window.scrollTo({ top: 0, behavior: 'smooth' }); // form alanına kaydır
    });

    function loadMapWithAddress(address) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(res => res.json())
            .then(geo => {
                if (geo && geo.length > 0) {
                    const lat = parseFloat(geo[0].lat);
                    const lon = parseFloat(geo[0].lon);
                    ymaps.ready(() => {
                        const map = new ymaps.Map("map", {
                            center: [lat, lon],
                            zoom: 14,
                            controls: ['zoomControl', 'fullscreenControl']
                        });
                        const placemark = new ymaps.Placemark([lat, lon], {
                            balloonContent: address
                        });
                        map.geoObjects.add(placemark);
                    });
                }
            })
            .catch(err => console.error("Harita yüklenemedi:", err));
    }

    const form = document.getElementById("contactForm");
    const successMessage = document.getElementById("successMessage");

    form.addEventListener("submit", async function (e) {
        e.preventDefault(); // Sayfanın yeniden yüklenmesini engelle

        const payload = {
            telefon: document.getElementById("phone").value,
            il: document.getElementById("province").value,
            ilce: document.getElementById("district").value,
            mahalle: document.getElementById("neighborhood").value,
            no: document.getElementById("addressNo").value
        };

        try {
            const response = await fetch("http://127.0.0.1:8000/api/iletisim-ekle/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok && result.status === "ok") {
                successMessage.style.display = "block"; // Başarı mesajı göster
                loadContactData(); // Ön izlemeyi güncelle
            } else {
                alert("Veri kaydedilirken hata oluştu.");
                console.error(result);
            }
        } catch (error) {
            console.error("İletişim bilgisi gönderilemedi:", error);
        }
    });

    // Menü açma/kapatma işlemi
    document.getElementById("menu-toggle").addEventListener("click", function () {
        document.getElementById("mobile-menu").classList.toggle("open");
    });

    document.querySelectorAll('.mobile-menu .has-submenu > a').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const parent = this.parentElement;
            parent.classList.toggle('open');
        });
    });

    
</script>

</body>
</html>