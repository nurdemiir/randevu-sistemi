<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İşletme Yönetimi - İletişim</title>
    <link rel="stylesheet" href="styles2.css">
    <script src="/frontend/src/js/businessInfo.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=tr_TR" type="text/javascript"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <img id="business-image" src="/frontend/src/assets/images/default-image.png" alt="İşletme Fotoğrafı">
            <h1 id="sidebar-h1">Varsayılan İşletme</h1>
            <h2 id="sidebar-h2">Panel</h2>
            <nav>
                <ul>
                    <li><a href="/frontend/public/pages/musteri_panel/randevu_al/index1.html">Randevu Al</a></li>
                    <li><a href="/frontend/public/pages/musteri_panel/galeri/index15.html">Galeri</a></li>
                    <li><a href="/frontend/public/pages/musteri_panel/sss/index3.html">Sıkça Sorulan Sorular</a></li>
                    <li><a href="/frontend/public/pages/musteri_panel/iletisim/index2.html">İletişim</a></li>
                </ul>
            </nav>
        </aside>

        <header class="mobile-header" id="mobile-header">
            <img id="mobile-business-image" src="/frontend/src/assets/images/default-image.png" alt="İşletme Fotoğrafı">
            <h1 id="mobile-business-name">İşletme Adı</h1>
        </header>

        <button class="mobile-menu-toggle" id="menu-toggle">&#9776;</button>

        <div class="mobile-menu" id="mobile-menu">
            <ul>
                <li><a href="/frontend/public/pages/musteri_panel/randevu_al/index1.html">Randevu Al</a></li>
                <li><a href="/frontend/public/pages/musteri_panel/galeri/index15.html">Galeri</a></li>
                <li><a href="/frontend/public/pages/musteri_panel/sss/index3.html">Sıkça Sorulan Sorular</a></li>
                <li><a href="/frontend/public/pages/musteri_panel/iletisim/index2.html">İletişim</a></li>
            </ul>
        </div>

        <main class="main-content">
            <section class="service-item">
                <h2>İletişim Bilgileri</h2>
                <div class="contact-details"></div>
                <div id="map" style="width: 100%; height: 300px; margin-top: 20px; border-radius: 8px;"></div>
            </section>
        </main>
    </div>

    <script>
        const contactDetailsDiv = document.querySelector('.contact-details');
        document.addEventListener('DOMContentLoaded', async function() {
            await loadBusinessInfo();

            try {
                const response = await fetch("http://127.0.0.1:8000/api/iletisim");
                const data = await response.json();

                if (response.ok) {
                    contactDetailsDiv.innerHTML = `
                        <p><strong>Telefon:</strong> ${data.telefon}</p>
                        <p><strong>İl:</strong> ${data.il}</p>
                        <p><strong>İlçe:</strong> ${data.ilce}</p>
                        <p><strong>Mahalle:</strong> ${data.mahalle}</p>
                        <p><strong>No:</strong> ${data.no}</p>
                    `;

                    const address = `${data.mahalle}, ${data.ilce}, ${data.il}`;
                    const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

                    fetch(geocodingUrl)
                        .then(response => response.json())
                        .then(geo => {
                            if (geo && geo.length > 0) {
                                const lat = parseFloat(geo[0].lat);
                                const lon = parseFloat(geo[0].lon);
                                const map = new ymaps.Map("map", {
                                    center: [lat, lon],
                                    zoom: 14,
                                    controls: ['zoomControl', 'fullscreenControl']
                                });
                                const placemark = new ymaps.Placemark([lat, lon], {
                                    balloonContent: address
                                });
                                map.geoObjects.add(placemark);
                            }
                        });
                } else {
                    contactDetailsDiv.innerHTML = `<p></p>`;
                }
            } catch (err) {
                console.error("İletişim verileri alınamadı:", err);
            }

            // Mobil menü aç/kapat
            const menuToggle = document.getElementById("menu-toggle");
            const mobileMenu = document.getElementById("mobile-menu");

            if (menuToggle && mobileMenu) {
                menuToggle.addEventListener("click", () => {
                    mobileMenu.classList.toggle("open");
                });
            }

            ymaps.ready(function() {
                const map = new ymaps.Map("map", {
                    center: [41.0082, 28.9784],
                    zoom: 14,
                    controls: ['zoomControl', 'fullscreenControl']
                });

                const address = `${neighborhood}, ${district}, ${province}`;
                const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

                fetch(geocodingUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            map.setCenter([lat, lon], 14);
                            const placemark = new ymaps.Placemark([lat, lon], {
                                balloonContent: `${neighborhood}, ${district}, ${province}`
                            });
                            map.geoObjects.add(placemark);
                        } else {
                            alert('Konum bulunamadı, varsayılan konum gösteriliyor.');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding hatası:', error);
                    });
            });
        });

        window.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch("http://localhost:8000/api/genel-ayarlar/liste");
                const ayarlar = await response.json();
                const ayar = ayarlar[0];

                if (ayar) {
                    // Ana başlık ve alt başlığı tüm sayfalarda güncelle
                    if (ayar.logo) {
                        document.getElementById("business-image").src = ayar.logo;
                        const mobileImage = document.getElementById("mobile-business-image");
                        if (mobileImage) mobileImage.src = ayar.logo;
                    }

                    if (ayar.isletme_adi) {
                        document.getElementById("sidebar-h1").textContent = ayar.isletme_adi;
                        const mobileName = document.getElementById("mobile-business-name");
                        if (mobileName) mobileName.textContent = ayar.isletme_adi;
                    }

                    if (ayar.aciklama) {
                        const subtitle = document.getElementById("sidebar-h2");
                        if (subtitle) subtitle.textContent = ayar.aciklama;
                    }
                }
            } catch (error) {
                console.error("Genel ayarlar alınamadı:", error);
            }
        });

    </script>
</body>
</html>